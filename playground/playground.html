<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Contribution Heatmap</title>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <style>
		body {
			display: flex;
			flex-direction: column;
			justify-content: center;
			align-items: center;
			height: 100vh;
			background-color: #1e1e1e;
			color: white;
			font-family: Arial, sans-serif;
		}

		.container {
			display: flex;
			flex-direction: column;
			width: 1200px;
			background-color: #2c2c2c;
			border-radius: 10px;
			padding: 10px;
			justify-content: center;
			align-content: center;
		}

		.plot-container {
			width: 100%;
			height: 369px;
			padding: 5px;
			border-radius: 10px;
		}

		#heatmap-container {
			width: 100%;
			height: 100%;
			transition: transform 0.5s ease;
		}

		#headerBar {
			display: flex;
			flex-direction: row;
			width: 100%;
			align-content: center;
			justify-content: center;
		}

		.year-selector {
			width: auto;
			height: 40px;
			display: flex;
			flex-direction: row;
			background-color: #1e1e1e;
			border-radius: 10px;
			padding: 5px;
		}

		.year-button {
			background-color: transparent;
			color: #aaa;
			border: none;
			padding: 5px;
			font-size: 18px;
			cursor: pointer;
			transition: background-color 0.3s ease;
			margin-bottom: 5px;
			width: 100%;
			text-align: center;
		}

		.year-button.selected {
			background-color: #2978ff;
			color: white;
		}

		.stat-tile {
			background-color: #1e1e1e;
			padding: 5px 25px;
			border-radius: 10px;
			text-align: center;
			height: 40px;
			width: auto;
			margin-left: 40px;
			display: flex;
			flex-direction: row;
			align-items: center;
			justify-content: space-evenly;
		}

		.stat-tile img {
			width: 24px;
			margin-bottom: 8px;
		}
    </style>
</head>
<body>
<div class="container">

    <div id="headerBar">
        <div class="year-selector" id="yearButtons"></div>

        <div class="stat-tile">
            <img src="https://img.icons8.com/ios-filled/50/ffffff/code-file.png" alt="commits icon">
            <h3 id="totalCommits">0</h3>
            <p>Total Commits</p>
        </div>

        <div class="stat-tile">
            <img src="https://img.icons8.com/ios-filled/50/ffffff/trophy.png" alt="streak icon">
            <h3 id="longestStreak">0</h3>
            <p>Longest Streak</p>
        </div>
    </div>

    <div class="plot-container">
        <div id="heatmap-container"></div>
    </div>
</div>

<script>
    let newData = {};  // To store the daily commit counts by year
    let currentYear = 0;

    // Function to process and group commits by day of week and week number
    function getHeatmapData(year) {
        const commitData = newData[year] || {};
        const dates = Object.keys(commitData);

        // Prepare empty array for 7 days (week rows) and 52 weeks (cols)
        const z = Array(7).fill().map(() => Array(52).fill(0));

        dates.forEach(date => {
            const currentDate = new Date(date);
            const dayOfWeek = currentDate.getDay();  // Sunday = 0, Monday = 1, ..., Saturday = 6
            const weekOfYear = Math.floor((currentDate - new Date(currentDate.getFullYear(), 0, 1)) / (7 * 24 * 60 * 60 * 1000));  // Calculate week number

            // Fill the matrix with commit data
            if (weekOfYear < 52) {  // Ensure we stay within 52 weeks
                z[dayOfWeek][weekOfYear] = commitData[date] || 0;
            }
        });

        return z;
    }

    // Function to update headerBar (Total Commits, Longest Streak)
    function updateStats(year) {
        const commitData = newData[year] || {};
        const dates = Object.keys(commitData);

        // Calculate total commits
        const totalCommits = dates.reduce((sum, date) => sum + commitData[date], 0);
        document.getElementById('totalCommits').innerText = totalCommits;

        // Calculate the longest streak (consecutive days with commits)
        let longestStreak = 0, currentStreak = 0;
        dates.sort((a, b) => new Date(a) - new Date(b)).forEach((date, index, array) => {
            if (index > 0 && (new Date(date) - new Date(array[index - 1])) / (1000 * 60 * 60 * 24) === 1) {
                currentStreak++;
            } else {
                longestStreak = Math.max(longestStreak, currentStreak);
                currentStreak = 1;
            }
        });
        longestStreak = Math.max(longestStreak, currentStreak);
        document.getElementById('longestStreak').innerText = longestStreak;
    }

    // Function to render the heatmap
    function renderHeatmap(year) {
        const z = getHeatmapData(year);
        const totalCommits = z.flat().reduce((sum, val) => sum + val, 0);  // Calculate total commits for the year

        const heatmapTrace = {
            z: z,
            type: 'heatmap',
            xgap: 1,
            ygap: 1,
            colorscale: 'Reds',
            zmin: 1,  // Avoid 0 on the log scale
            zmax: Math.max(...z.flat()),  // Set zmax based on the highest commit count
            showscale: true,
            colorbar: {
                title: 'Commits',
                thickness: 10
            },
            hovertemplate: 'Week %{x}, Day %{y}: %{z} commits<extra></extra>',
        };

        const heatmapLayout = {
            xaxis: {
                showticklabels: false,
                ticks: '',
                showgrid: false,
                showline: false,
                zeroline: false,
                automargin: true,
                range: [0, 51],
            },
            yaxis: {
                showticklabels: false,
                ticks: '',
                showgrid: false,
                zeroline: false,
                showline: false,
                automargin: true,
                range: [-0.5, 6.5],
            },
            xgap: 4,
            ygap: 4,
            paper_bgcolor: 'rgba(0,0,0,0)',
            plot_bgcolor: 'rgba(0,0,0,0)',
        };

        Plotly.newPlot('heatmap-container', [heatmapTrace], heatmapLayout);

        // Update the headerBar section
        updateStats(year);
    }

    // Handle year change
    function changeYear(year) {
        if (year === currentYear) return;  // Don't re-render if the year hasn't changed

        // Remove 'selected' class from the currently selected button, if any
        const selectedButton = document.querySelector('.year-button.selected');
        if (selectedButton) {
            selectedButton.classList.remove('selected');
        }

        // Add 'selected' class to the newly selected button using its id
        const newSelectedButton = document.getElementById(`buttonFor${year}`);
        if (newSelectedButton) {
            newSelectedButton.classList.add('selected');
        }

        // Render the heatmap
        renderHeatmap(year);
        currentYear = year;
    }

    // Function to generate buttons dynamically
    function generateYearButtons() {
        const yearButtonsContainer = document.getElementById('yearButtons');
        const years = Object.keys(newData).sort((a, b) => b - a);  // Sort years descending

        years.forEach(year => {
            const button = document.createElement('button');
            button.className = 'year-button';
            button.id = `buttonFor${year}`;  // Set a unique id for each button
            button.textContent = year;
            button.addEventListener('click', () => changeYear(year));  // Add event listener for year change
            yearButtonsContainer.appendChild(button);
        });

        // Ensure the button exists before adding the 'selected' class
        const defaultButton = document.getElementById(`buttonFor${years[0]}`);
        if (defaultButton) {
            defaultButton.classList.add('selected');  // Set the first button (latest year) as selected
        }
    }


    // Fetch the JSON file dynamically and initialize
    fetch('github_user_report.json')
        .then(response => response.json())
        .then(data => {
            data.repositories.forEach(repo => {
                repo.daily_log.forEach(log => {
                    const date = log.date;
                    const year = new Date(date).getFullYear();
                    currentYear = Math.max(year, currentYear);

                    if (!newData[year]) newData[year] = {};
                    if (!newData[year][date]) newData[year][date] = 0;

                    newData[year][date] += log.commits;
                });
            });

            generateYearButtons();  // Generate buttons after data is loaded
            renderHeatmap(currentYear);  // Initial render with default year
        })
        .catch(error => console.error('Error fetching JSON:', error));
</script>
</body>
</html>
